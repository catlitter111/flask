<!-- é™ªä¼´å†å²é¡µé¢ -->
<view class="history-container">
  <!-- çŠ¶æ€æ  -->
  <view class="status-bar">
    <view class="connection-status {{isConnected ? 'connected' : 'disconnected'}}">
      <text class="status-icon">{{isConnected ? 'â—' : 'â—‹'}}</text>
      <text class="status-text">{{isConnected ? 'å·²è¿æ¥' : 'æœªè¿æ¥'}}</text>
    </view>
    <view class="tracking-status {{isTracking ? 'tracking' : 'idle'}}">
      <text class="status-icon">{{isTracking ? 'ğŸ“' : 'â­•'}}</text>
      <text class="status-text">{{isTracking ? 'è¿½è¸ªä¸­' : 'å¾…æœºä¸­'}}</text>
    </view>
  </view>

  <!-- ç»Ÿè®¡å¡ç‰‡ -->
  <view class="stats-section">
    <view class="stats-card">
      <view class="stats-item">
        <text class="stats-value">{{totalTracks}}</text>
        <text class="stats-label">æ€»è½¨è¿¹</text>
        <text class="stats-icon">ğŸ›¤ï¸</text>
      </view>
      <view class="stats-item">
        <text class="stats-value">{{totalDistance}}</text>
        <text class="stats-label">æ€»è·ç¦»</text>
        <text class="stats-icon">ğŸ“</text>
      </view>
      <view class="stats-item">
        <text class="stats-value">{{totalDuration}}</text>
        <text class="stats-label">æ€»æ—¶é•¿</text>
        <text class="stats-icon">â±ï¸</text>
      </view>
      <view class="stats-item">
        <text class="stats-value">{{averageSpeed}}</text>
        <text class="stats-label">å¹³å‡é€Ÿåº¦</text>
        <text class="stats-icon">ğŸš€</text>
      </view>
    </view>
  </view>

  <!-- å®æ—¶è¿½è¸ªæ§åˆ¶ -->
  <view class="tracking-control" wx:if="{{isConnected}}">
    <button class="robot-btn tracking-btn {{isTracking ? 'stop' : 'start'}}" 
            bindtap="{{isTracking ? 'stopTracking' : 'startTracking'}}">
      <text class="btn-icon">{{isTracking ? 'â¹ï¸' : 'â–¶ï¸'}}</text>
      <text class="btn-text">{{isTracking ? 'åœæ­¢è¿½è¸ª' : 'å¼€å§‹è¿½è¸ª'}}</text>
    </button>
    <view class="tracking-progress" wx:if="{{isTracking}}">
      <text class="progress-text">è¿½è¸ªè¿›è¡Œä¸­...</text>
      <view class="progress-bar">
        <view class="progress-fill" style="width: {{trackingProgress}}%"></view>
      </view>
    </view>
  </view>

  <!-- ç­›é€‰å’Œæ’åº -->
  <view class="filter-section">
    <view class="filter-tabs">
      <view class="filter-tab {{currentFilter === 'all' ? 'active' : ''}}" 
            bindtap="setFilter" data-filter="all">
        <text>å…¨éƒ¨</text>
      </view>
      <view class="filter-tab {{currentFilter === 'today' ? 'active' : ''}}" 
            bindtap="setFilter" data-filter="today">
        <text>ä»Šå¤©</text>
      </view>
      <view class="filter-tab {{currentFilter === 'week' ? 'active' : ''}}" 
            bindtap="setFilter" data-filter="week">
        <text>æœ¬å‘¨</text>
      </view>
      <view class="filter-tab {{currentFilter === 'month' ? 'active' : ''}}" 
            bindtap="setFilter" data-filter="month">
        <text>æœ¬æœˆ</text>
      </view>
    </view>
    <view class="sort-control">
      <text class="sort-label">æ’åº:</text>
      <picker bindchange="onSortChange" value="{{sortIndex}}" range="{{sortOptions}}" range-key="name">
        <view class="sort-picker">
          <text>{{sortOptions[sortIndex].name}}</text>
          <text class="sort-icon">â–¼</text>
        </view>
      </picker>
    </view>
  </view>

  <!-- è½¨è¿¹åˆ—è¡¨ -->
  <view class="tracks-section">
    <view class="section-header">
      <text class="section-title">è½¨è¿¹è®°å½•</text>
      <text class="section-count">({{filteredTracks.length}})</text>
    </view>
    
    <scroll-view class="tracks-list" scroll-y="true" enable-flex="true">
      <view class="track-item" wx:for="{{filteredTracks}}" wx:key="id" bindtap="viewTrackDetail" data-track="{{item}}">
        <view class="track-header">
          <view class="track-info">
            <text class="track-name">{{item.name || 'è½¨è¿¹ ' + (index + 1)}}</text>
            <text class="track-date">{{item.formattedDate}}</text>
          </view>
          <view class="track-status {{item.status}}">
            <text class="status-dot"></text>
            <text class="status-text">{{item.statusText}}</text>
          </view>
        </view>
        
        <view class="track-stats">
          <view class="track-stat">
            <text class="stat-icon">ğŸ“</text>
            <text class="stat-value">{{item.pointCount}} ç‚¹</text>
          </view>
          <view class="track-stat">
            <text class="stat-icon">ğŸ“</text>
            <text class="stat-value">{{item.formattedDistance}}</text>
          </view>
          <view class="track-stat">
            <text class="stat-icon">â±ï¸</text>
            <text class="stat-value">{{item.formattedDuration}}</text>
          </view>
          <view class="track-stat">
            <text class="stat-icon">ğŸš€</text>
            <text class="stat-value">{{item.formattedSpeed}}</text>
          </view>
        </view>
        
        <view class="track-preview" wx:if="{{item.previewPoints && item.previewPoints.length > 0}}">
          <map 
            class="mini-map" 
            latitude="{{item.centerLat}}" 
            longitude="{{item.centerLng}}" 
            scale="16"
            markers="{{item.previewMarkers}}"
            polyline="{{item.previewPolyline}}"
            show-location="false"
            enable-scroll="false"
            enable-zoom="false"
            enable-rotate="false">
          </map>
        </view>
        
        <view class="track-actions">
          <button class="action-btn view-btn" bindtap="viewTrackDetail" data-track="{{item}}" catchtap="true">
            <text class="btn-icon">ğŸ‘ï¸</text>
            <text class="btn-text">æŸ¥çœ‹</text>
          </button>
          <button class="action-btn share-btn" bindtap="shareTrack" data-track="{{item}}" catchtap="true">
            <text class="btn-icon">ğŸ“¤</text>
            <text class="btn-text">åˆ†äº«</text>
          </button>
          <button class="action-btn export-btn" bindtap="exportTrack" data-track="{{item}}" catchtap="true">
            <text class="btn-icon">ğŸ’¾</text>
            <text class="btn-text">å¯¼å‡º</text>
          </button>
        </view>
      </view>
      
      <!-- ç©ºçŠ¶æ€ -->
      <view class="empty-state" wx:if="{{filteredTracks.length === 0}}">
        <text class="empty-icon">ğŸ¤–</text>
        <text class="empty-title">æš‚æ— è½¨è¿¹è®°å½•</text>
        <text class="empty-desc">{{isConnected ? 'å¼€å§‹è¿½è¸ªä»¥è®°å½•æœºå™¨äººçš„è¡ŒåŠ¨è½¨è¿¹' : 'è¯·å…ˆè¿æ¥æœºå™¨äºº'}}</text>
      </view>
    </scroll-view>
  </view>

  <!-- æ‰¹é‡æ“ä½œ -->
  <view class="batch-actions" wx:if="{{filteredTracks.length > 0}}">
    <button class="robot-btn batch-btn" bindtap="exportAllTracks">
      <text class="btn-icon">ğŸ“¦</text>
      <text class="btn-text">å¯¼å‡ºå…¨éƒ¨</text>
    </button>
    <button class="robot-btn batch-btn" bindtap="clearAllTracks">
      <text class="btn-icon">ğŸ—‘ï¸</text>
      <text class="btn-text">æ¸…ç©ºè®°å½•</text>
    </button>
  </view>
</view>

<!-- è½¨è¿¹è¯¦æƒ…æ¨¡æ€æ¡† -->
<view class="modal-overlay" wx:if="{{showTrackDetail}}" bindtap="closeTrackDetail">
  <view class="modal-content track-detail-modal" catchtap="true">
    <view class="modal-header">
      <text class="modal-title">è½¨è¿¹è¯¦æƒ…</text>
      <button class="modal-close" bindtap="closeTrackDetail">âœ•</button>
    </view>
    
    <scroll-view class="modal-body" scroll-y="true">
      <view class="detail-section">
        <text class="detail-label">è½¨è¿¹åç§°</text>
        <text class="detail-value">{{selectedTrack.name || 'æœªå‘½åè½¨è¿¹'}}</text>
      </view>
      
      <view class="detail-section">
        <text class="detail-label">è®°å½•æ—¶é—´</text>
        <text class="detail-value">{{selectedTrack.formattedDate}}</text>
      </view>
      
      <view class="detail-section">
        <text class="detail-label">è½¨è¿¹ç»Ÿè®¡</text>
        <view class="detail-stats">
          <view class="detail-stat">
            <text class="stat-label">æ€»ç‚¹æ•°</text>
            <text class="stat-value">{{selectedTrack.pointCount}}</text>
          </view>
          <view class="detail-stat">
            <text class="stat-label">æ€»è·ç¦»</text>
            <text class="stat-value">{{selectedTrack.formattedDistance}}</text>
          </view>
          <view class="detail-stat">
            <text class="stat-label">æ€»æ—¶é•¿</text>
            <text class="stat-value">{{selectedTrack.formattedDuration}}</text>
          </view>
          <view class="detail-stat">
            <text class="stat-label">å¹³å‡é€Ÿåº¦</text>
            <text class="stat-value">{{selectedTrack.formattedSpeed}}</text>
          </view>
        </view>
      </view>
      
      <view class="detail-section">
        <text class="detail-label">è½¨è¿¹åœ°å›¾</text>
        <map 
          class="detail-map" 
          latitude="{{selectedTrack.centerLat}}" 
          longitude="{{selectedTrack.centerLng}}" 
          scale="15"
          markers="{{selectedTrack.detailMarkers}}"
          polyline="{{selectedTrack.detailPolyline}}"
          show-location="true">
        </map>
      </view>
    </scroll-view>
    
    <view class="modal-footer">
      <button class="modal-btn secondary" bindtap="closeTrackDetail">å…³é—­</button>
      <button class="modal-btn primary" bindtap="exportCurrentTrack">å¯¼å‡ºè½¨è¿¹</button>
    </view>
  </view>
</view>

<!-- å¯¼å‡ºé€‰é¡¹æ¨¡æ€æ¡† -->
<view class="modal-overlay" wx:if="{{showExportOptions}}" bindtap="closeExportOptions">
  <view class="modal-content export-options-modal" catchtap="true">
    <view class="modal-header">
      <text class="modal-title">é€‰æ‹©å¯¼å‡ºæ ¼å¼</text>
      <button class="modal-close" bindtap="closeExportOptions">âœ•</button>
    </view>
    
    <view class="modal-body">
      <view class="export-option" bindtap="exportAs" data-format="gpx">
        <text class="option-icon">ğŸ—ºï¸</text>
        <view class="option-content">
          <text class="option-title">GPX æ ¼å¼</text>
          <text class="option-desc">GPS æ ‡å‡†æ ¼å¼ï¼Œå…¼å®¹å„ç§åœ°å›¾åº”ç”¨</text>
        </view>
      </view>
      
      <view class="export-option" bindtap="exportAs" data-format="kml">
        <text class="option-icon">ğŸŒ</text>
        <view class="option-content">
          <text class="option-title">KML æ ¼å¼</text>
          <text class="option-desc">Google Earth å’Œåœ°å›¾åº”ç”¨æ”¯æŒ</text>
        </view>
      </view>
      
      <view class="export-option" bindtap="exportAs" data-format="json">
        <text class="option-icon">ğŸ“‹</text>
        <view class="option-content">
          <text class="option-title">JSON æ ¼å¼</text>
          <text class="option-desc">ç¨‹åºå‘˜å‹å¥½çš„æ•°æ®æ ¼å¼</text>
        </view>
      </view>
      
      <view class="export-option" bindtap="exportAs" data-format="csv">
        <text class="option-icon">ğŸ“Š</text>
        <view class="option-content">
          <text class="option-title">CSV æ ¼å¼</text>
          <text class="option-desc">Excel å’Œæ•°æ®åˆ†æå·¥å…·æ”¯æŒ</text>
        </view>
      </view>
    </view>
    
    <view class="modal-footer">
      <button class="modal-btn secondary" bindtap="closeExportOptions">å–æ¶ˆ</button>
    </view>
  </view>
</view>

<!-- åŠ è½½çŠ¶æ€ -->
<view class="loading-overlay" wx:if="{{isLoading}}">
  <view class="loading-content">
    <text class="loading-icon">ğŸ¤–</text>
    <text class="loading-text">{{loadingText}}</text>
  </view>
</view>