<!-- pages/rfid/history/history.wxml - RFIDå†å²è®°å½•é¡µé¢ -->
<view class="container">
  <!-- é¡¶éƒ¨ç»Ÿè®¡å¡ç‰‡ -->
  <view class="stats-section">
    <view class="stats-card">
      <view class="stats-grid">
        <view class="stat-item">
          <text class="stat-value">{{totalRecords}}</text>
          <text class="stat-label">æ€»è®°å½•</text>
        </view>
        <view class="stat-item">
          <text class="stat-value detected">{{detectedCount}}</text>
          <text class="stat-label">æ£€æµ‹åˆ°</text>
        </view>
        <view class="stat-item">
          <text class="stat-value lost">{{lostCount}}</text>
          <text class="stat-label">ç¦»çº¿</text>
        </view>
        <view class="stat-item">
          <text class="stat-value">{{uniqueTagsCount}}</text>
          <text class="stat-label">å”¯ä¸€æ ‡ç­¾</text>
        </view>
      </view>
    </view>
  </view>

  <!-- ç­›é€‰å’Œæ“ä½œæ  -->
  <view class="filter-section">
    <view class="filter-row">
      <!-- ç­›é€‰é€‰é¡¹ -->
      <picker class="filter-picker" mode="selector" 
              range="{{['å…¨éƒ¨', 'æ£€æµ‹åˆ°', 'ç¦»çº¿']}}" 
              range-key="å…¨éƒ¨,detected,lost"
              value="{{filterType}}" 
              bindchange="onFilterTypeChange">
        <view class="picker-display">
          <text class="picker-text">{{filterType === 'all' ? 'å…¨éƒ¨' : (filterType === 'detected' ? 'æ£€æµ‹åˆ°' : 'ç¦»çº¿')}}</text>
          <text class="picker-arrow">â–¼</text>
        </view>
      </picker>

      <picker class="filter-picker" mode="selector" 
              range="{{['ä»Šå¤©', 'æœ€è¿‘ä¸€å‘¨', 'æœ€è¿‘ä¸€æœˆ', 'å…¨éƒ¨']}}"
              range-key="today,week,month,all" 
              value="{{dateFilter}}" 
              bindchange="onDateFilterChange">
        <view class="picker-display">
          <text class="picker-text">
            {{dateFilter === 'today' ? 'ä»Šå¤©' : (dateFilter === 'week' ? 'æœ€è¿‘ä¸€å‘¨' : (dateFilter === 'month' ? 'æœ€è¿‘ä¸€æœˆ' : 'å…¨éƒ¨'))}}
          </text>
          <text class="picker-arrow">â–¼</text>
        </view>
      </picker>

      <!-- æœç´¢æŒ‰é’® -->
      <view class="action-btn search-btn" bindtap="toggleSearch">
        <text class="btn-icon">ğŸ”</text>
      </view>
    </view>

    <!-- æœç´¢æ¡† -->
    <view class="search-row" wx:if="{{showSearch}}">
      <input class="search-input" 
             placeholder="æœç´¢EPCæˆ–åŠ¨ä½œç±»å‹" 
             value="{{searchKeyword}}"
             bindinput="onSearchInput" />
    </view>

    <!-- æ’åºå’Œæ“ä½œ -->
    <view class="operation-row">
      <picker class="sort-picker" mode="selector" 
              range="{{['æ—¶é—´é™åº', 'æ—¶é—´å‡åº', 'EPCå‡åº', 'EPCé™åº']}}"
              range-key="time_desc,time_asc,epc_asc,epc_desc"
              value="{{sortBy}}" 
              bindchange="onSortChange">
        <view class="sort-display">
          <text class="sort-icon">ğŸ“Š</text>
          <text class="sort-text">æ’åº</text>
        </view>
      </picker>

      <view class="operation-btns">
        <view class="operation-btn" bindtap="toggleSelectionMode">
          <text class="btn-icon">{{selectionMode ? 'âœ“' : 'â˜'}}</text>
          <text class="btn-text">é€‰æ‹©</text>
        </view>
        <view class="operation-btn" bindtap="exportData">
          <text class="btn-icon">ğŸ“¤</text>
          <text class="btn-text">å¯¼å‡º</text>
        </view>
      </view>
    </view>
  </view>

  <!-- é€‰æ‹©æ¨¡å¼æ“ä½œæ  -->
  <view class="selection-bar" wx:if="{{selectionMode}}">
    <view class="selection-info">
      <text>å·²é€‰æ‹© {{selectedItems.length}} é¡¹</text>
    </view>
    <view class="selection-actions">
      <button class="selection-btn" bindtap="toggleSelectAll">
        {{selectedItems.length === filteredHistory.length ? 'å–æ¶ˆå…¨é€‰' : 'å…¨é€‰'}}
      </button>
      <button class="selection-btn delete" bindtap="deleteSelected">åˆ é™¤</button>
      <button class="selection-btn" bindtap="toggleSelectionMode">å–æ¶ˆ</button>
    </view>
  </view>

  <!-- å†å²è®°å½•åˆ—è¡¨ -->
  <view class="history-section">
    <scroll-view class="history-list" 
                 scroll-y 
                 bindscrolltolower="loadMore"
                 enhanced="{{true}}"
                 show-scrollbar="{{false}}">
      
      <!-- åŠ è½½çŠ¶æ€ -->
      <view class="loading-state" wx:if="{{loading && filteredHistory.length === 0}}">
        <view class="loading-icon">â³</view>
        <text class="loading-text">åŠ è½½ä¸­...</text>
      </view>

      <!-- å†å²è®°å½•é¡¹ -->
      <view class="history-item {{selectionMode ? 'selection-mode' : ''}}" 
            wx:for="{{filteredHistory}}" 
            wx:key="id"
            bindtap="{{selectionMode ? 'toggleItemSelection' : 'viewDetails'}}"
            data-item="{{item}}"
            data-id="{{item.id}}">
        
        <!-- é€‰æ‹©æ¡† -->
        <view class="selection-box" wx:if="{{selectionMode}}">
          <view class="checkbox {{selectedItems.indexOf(item.id) > -1 ? 'checked' : ''}}">
            <text class="check-icon" wx:if="{{selectedItems.indexOf(item.id) > -1}}">âœ“</text>
          </view>
        </view>

        <!-- æ—¶é—´è½´ -->
        <view class="timeline">
          <view class="timeline-dot {{item.action}}"></view>
          <view class="timeline-line" wx:if="{{index < filteredHistory.length - 1}}"></view>
        </view>

        <!-- å†…å®¹åŒºåŸŸ -->
        <view class="item-content">
          <view class="item-header">
            <view class="action-badge {{item.action}}">
              <text class="action-icon">{{item.actionIcon}}</text>
              <text class="action-text">{{item.actionText}}</text>
            </view>
            <text class="item-time">{{item.timeOnly}}</text>
          </view>

          <view class="item-body">
            <text class="epc-code">{{item.shortEpc}}</text>
            <view class="item-details">
              <text class="detail-item">RSSI: {{item.rssi}}dBm</text>
              <text class="detail-separator">|</text>
              <text class="detail-item">å¤©çº¿: {{item.antenna}}</text>
              <text class="detail-separator">|</text>
              <text class="detail-item">è¯»å–: {{item.readCount}}æ¬¡</text>
              <text class="detail-separator" wx:if="{{item.duration}}">|</text>
              <text class="detail-item" wx:if="{{item.duration}}">æŒç»­: {{item.durationText}}</text>
            </view>
          </view>

          <view class="item-footer">
            <text class="date-text">{{item.dateString}}</text>
            <view class="item-actions" wx:if="{{!selectionMode}}">
              <text class="action-hint">ç‚¹å‡»æŸ¥çœ‹è¯¦æƒ…</text>
            </view>
          </view>
        </view>
      </view>

      <!-- åŠ è½½æ›´å¤š -->
      <view class="load-more" wx:if="{{hasMore && !loading}}">
        <text class="load-more-text">ä¸Šæ‹‰åŠ è½½æ›´å¤š</text>
      </view>

      <!-- æ²¡æœ‰æ›´å¤šæ•°æ® -->
      <view class="no-more" wx:if="{{!hasMore && filteredHistory.length > 0}}">
        <text class="no-more-text">æ²¡æœ‰æ›´å¤šè®°å½•äº†</text>
      </view>

      <!-- ç©ºçŠ¶æ€ -->
      <view class="empty-state" wx:if="{{filteredHistory.length === 0 && !loading}}">
        <text class="empty-icon">ğŸ“</text>
        <text class="empty-title">æš‚æ— å†å²è®°å½•</text>
        <text class="empty-desc">
          {{searchKeyword ? 'æ²¡æœ‰æ‰¾åˆ°åŒ¹é…çš„è®°å½•' : 'å¼€å§‹ä½¿ç”¨RFIDæ‰«æåä¼šæ˜¾ç¤ºå†å²è®°å½•'}}
        </text>
      </view>
    </scroll-view>
  </view>

  <!-- åº•éƒ¨æ“ä½œæ  -->
  <view class="bottom-actions" wx:if="{{!selectionMode}}">
    <button class="bottom-btn secondary" bindtap="clearAllHistory">
      <text class="btn-icon">ğŸ—‘ï¸</text>
      <text>æ¸…ç©ºå†å²</text>
    </button>
    <button class="bottom-btn primary" bindtap="exportData">
      <text class="btn-icon">ğŸ“Š</text>
      <text>å¯¼å‡ºæŠ¥å‘Š</text>
    </button>
  </view>
</view>