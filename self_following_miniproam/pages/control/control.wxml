<!-- pages/control/control.wxml - æœºå™¨äººä¼´ä¾£æ§åˆ¶é¡µé¢ -->
<wxs module="utils" src="./utils.wxs"></wxs>
<view class="container">
  <!-- è§†é¢‘å®¹å™¨ï¼Œé«˜åº¦åŠ¨æ€è°ƒæ•´ -->
  <view class="video-container" style="height: {{videoHeight}}vh;">
    <view class="video-placeholder">
      <!-- æ ¹æ®ä¸åŒçŠ¶æ€æ˜¾ç¤ºä¸åŒå†…å®¹ -->
      <block wx:if="{{!connected}}">
        <view class="no-connection">
          <image src="/images/server-offline.png" mode="aspectFit"></image>
          <text>æœåŠ¡å™¨æœªè¿æ¥</text>
        </view>
      </block>
      <block wx:elif="{{!robotConnected}}">
        <view class="no-connection">
          <image src="/images/companion-offline.png" mode="aspectFit"></image>
          <text>ä¼´ä¾£æœªè¿æ¥</text>
        </view>
      </block>
      <block wx:elif="{{videoExpired}}">
        <view class="no-connection">
          <image src="/images/video-timeout.png" mode="aspectFit"></image>
          <text>è§†é¢‘è¿æ¥è¶…æ—¶</text>
        </view>
      </block>
      <block wx:elif="{{videoBase64}}">
        <image 
          src="{{videoBase64}}" 
          mode="aspectFill"
          lazy-load="{{false}}"
          show-menu-by-longpress="{{false}}"
        ></image>
      </block>
      <block wx:else>
        <view class="loading-connection">
          <image src="/images/loading.png" mode="aspectFit" class="rotating"></image>
          <text>åŠ è½½è§†é¢‘ä¸­...</text>
        </view>
      </block>
      
      <view class="connection-status {{connected && robotConnected ? 'connected' : 'disconnected'}}">
        {{connectionStatusText}}
      </view>
      
      <!-- è§†é¢‘è´¨é‡æŒ‡ç¤ºå™¨ (ä»…åœ¨è¿æ¥çŠ¶æ€æ˜¾ç¤º) -->
      <view class="video-quality-indicator" bindtap="toggleQualityPanel" wx:if="{{connected && robotConnected && !videoExpired && videoBase64}}">
        <text class="quality-label">{{qualityLabels[currentQuality]}}</text>
        <text class="quality-stats">{{videoFps}}fps | {{frameLatency}}ms</text>
      </view>
    </view>
    
    <!-- è§†é¢‘è´¨é‡è®¾ç½®é¢æ¿ -->
    <view class="quality-panel" wx:if="{{showQualityPanel}}">
      <view class="quality-panel-header">
        <text class="quality-panel-title">è§†é¢‘è´¨é‡è®¾ç½®</text>
        <view class="auto-quality-switch">
          <text>è‡ªåŠ¨è°ƒæ•´</text>
          <switch checked="{{autoQuality}}" bindchange="toggleAutoQuality" color="#007ACC" />
        </view>
      </view>
      
      <view class="quality-presets">
        <view class="quality-preset-item {{currentQuality === 'high' ? 'active' : ''}}" 
              bindtap="selectQualityPreset" data-preset="high">
          <text class="preset-name">é«˜æ¸…</text>
          <text class="preset-info">640Ã—480 | 15fps</text>
        </view>
        <view class="quality-preset-item {{currentQuality === 'medium' ? 'active' : ''}}" 
              bindtap="selectQualityPreset" data-preset="medium">
          <text class="preset-name">æ ‡å‡†</text>
          <text class="preset-info">480Ã—360 | 10fps</text>
        </view>
        <view class="quality-preset-item {{currentQuality === 'low' ? 'active' : ''}}" 
              bindtap="selectQualityPreset" data-preset="low">
          <text class="preset-name">æµç•…</text>
          <text class="preset-info">320Ã—240 | 8fps</text>
        </view>
        <view class="quality-preset-item {{currentQuality === 'very_low' ? 'active' : ''}}" 
              bindtap="selectQualityPreset" data-preset="very_low">
          <text class="preset-name">çœæµ</text>
          <text class="preset-info">240Ã—180 | 5fps</text>
        </view>
        <view class="quality-preset-item {{currentQuality === 'minimum' ? 'active' : ''}}" 
              bindtap="selectQualityPreset" data-preset="minimum">
          <text class="preset-name">æœ€å°</text>
          <text class="preset-info">160Ã—120 | 3fps</text>
        </view>
      </view>
      
      <view class="quality-stats-panel">
        <view class="stats-item">
          <text class="stats-label">å½“å‰å»¶è¿Ÿ:</text>
          <text class="stats-value">{{frameLatency}}ms</text>
        </view>
        <view class="stats-item">
          <text class="stats-label">å¸§ç‡:</text>
          <text class="stats-value">{{framesPerSecond}}fps</text>
        </view>
        <view class="stats-item">
          <text class="stats-label">æŠ–åŠ¨:</text>
          <text class="stats-value">{{frameJitter}}ms</text>
        </view>
        <view class="stats-item">
          <text class="stats-label">ç¼“å†²å¥åº·åº¦:</text>
          <progress percent="{{bufferHealth}}" stroke-width="4" activeColor="{{bufferHealth > 60 ? '#007ACC' : '#E07B39'}}" backgroundColor="#eee" />
          <text class="stats-value">{{bufferHealth}}%</text>
        </view>
      </view>
      
      <button class="close-panel-btn" bindtap="toggleQualityPanel">å…³é—­</button>
    </view>
    
    <view class="video-info">
      <view class="info-item">
        <text class="label">ä¼´ä¾£çŠ¶æ€ï¼š</text>
        <text class="value {{robotConnected ? 'online' : 'offline'}}">{{robotConnected ? 'åœ¨çº¿' : 'ç¦»çº¿'}}</text>
      </view>
      <view class="info-item">
        <text class="label">ç”µæ± ç”µé‡ï¼š</text>
        <text class="value">{{robotConnected ? batteryLevel + '%' : '--'}}</text>
      </view>
      <view class="info-item">
        <text class="label">ä¿¡å·å¼ºåº¦ï¼š</text>
        <text class="value">{{robotConnected ? signalStrength : '--'}}</text>
      </view>
    </view>
  </view>
  
  <!-- æ‹–æ‹½åˆ†éš”æ¡ -->
  <view class="drag-divider {{isDragging ? 'dragging' : ''}}" 
        bindtouchstart="handleDragStart"
        bindtouchmove="handleDragMove"
        bindtouchend="handleDragEnd"
        bindtouchcancel="handleDragEnd">
    <view class="drag-handle">
      <view class="drag-line"></view>
      <view class="drag-line"></view>
      <view class="drag-line"></view>
    </view>
    <!-- æ‹–æ‹½æç¤º -->
    <view class="drag-hint" wx:if="{{showDragHint}}">
      <text>â†• ä¸Šä¸‹æ‹–åŠ¨è°ƒæ•´è§†é¢‘å¤§å°</text>
    </view>
  </view>

  <!-- æ§åˆ¶å®¹å™¨ï¼Œé«˜åº¦è‡ªé€‚åº” -->
  <scroll-view class="control-container {{!robotConnected ? 'disabled' : ''}}" 
               scroll-y="true"
               style="height: calc(100vh - {{videoHeight}}vh - {{statusBarHeight + navBarHeight}}px - 40rpx);">
    
    <!-- Tabåˆ‡æ¢æ  -->
    <view class="tab-header">
      <view class="tab-nav">
        <view class="tab-item {{currentTab === 'control' ? 'active' : ''}}" 
              bindtap="switchTab" data-tab="control">
          <text class="tab-icon">ğŸ®</text>
          <text class="tab-text">æ§åˆ¶</text>
        </view>
        <view class="tab-item {{currentTab === 'data' ? 'active' : ''}}" 
              bindtap="switchTab" data-tab="data">
          <text class="tab-icon">ğŸ“Š</text>
          <text class="tab-text">æ•°æ®</text>
        </view>
      </view>
    </view>

    <!-- æ§åˆ¶é¡µé¢å†…å®¹ -->
    <view class="tab-content" wx:if="{{currentTab === 'control'}}">
      <view class="control-header">
        <text class="title">ä¼´ä¾£æ§åˆ¶</text>
        <view class="mode-switch">
          <text class="{{operationMode === 'manual' ? 'active' : ''}}">æ‰‹åŠ¨æ¨¡å¼</text>
          <switch checked="{{operationMode === 'auto'}}" bindchange="switchMode" color="#007ACC" />
          <text class="{{operationMode === 'auto' ? 'active' : ''}}">è‡ªåŠ¨æ¨¡å¼</text>
        </view>
      </view>

    <view class="control-panel" wx:if="{{operationMode === 'manual'}}">
      <!-- æ§åˆ¶ç±»å‹åˆ‡æ¢ -->
      <view class="control-type-switch">
        <text class="control-type-title">æ§åˆ¶ç±»å‹</text>
        <view class="control-type-selector">
          <text class="{{controlType === 'motor' ? 'active' : ''}}">ç§»åŠ¨æ§åˆ¶</text>
          <switch checked="{{controlType === 'companion'}}" bindchange="switchControlType" color="#E07B39" />
          <text class="{{controlType === 'companion' ? 'active' : ''}}">äº¤äº’æ§åˆ¶</text>
        </view>
        <view class="control-type-description">
          <text class="description-text">{{controlType === 'companion' ? 'æ§åˆ¶ä¼´ä¾£å¤´éƒ¨åŠ¨ä½œï¼šæŠ¬å¤´ä½å¤´å·¦å³è½¬å¤´è¿›è¡Œäº’åŠ¨' : 'æ§åˆ¶ä¼´ä¾£ç§»åŠ¨ï¼šå‰è¿›åé€€å·¦è½¬å³è½¬é™ªä½ èµ°åŠ¨'}}</text>
        </view>
      </view>
      
      <view class="direction-controls">
        <view class="btn-row">
          <button class="btn-control btn-transparent"></button>
          <button class="btn-control btn-direction {{controlType === 'companion' ? 'btn-companion-control' : ''}}" bindtap="moveForward">
            <text class="iconfont icon-up">â†‘</text>
            <text class="btn-label" wx:if="{{controlType === 'companion'}}">æŠ¬å¤´</text>
          </button>
          <button class="btn-control btn-transparent"></button>
        </view>
        <view class="btn-row">
          <button class="btn-control btn-direction {{controlType === 'companion' ? 'btn-companion-control' : ''}}" bindtap="moveLeft">
            <text class="iconfont icon-left">â†</text>
            <text class="btn-label" wx:if="{{controlType === 'companion'}}">å·¦è½¬</text>
          </button>
          <button class="btn-control btn-stop" bindtap="stopMovement">
            <text class="iconfont icon-stop">â– </text>
            <text class="btn-label">åœæ­¢</text>
          </button>
          <button class="btn-control btn-direction {{controlType === 'companion' ? 'btn-companion-control' : ''}}" bindtap="moveRight">
            <text class="iconfont icon-right">â†’</text>
            <text class="btn-label" wx:if="{{controlType === 'companion'}}">å³è½¬</text>
          </button>
        </view>
        <view class="btn-row">
          <button class="btn-control btn-transparent"></button>
          <button class="btn-control btn-direction {{controlType === 'companion' ? 'btn-companion-control' : ''}}" bindtap="moveBackward">
            <text class="iconfont icon-down">â†“</text>
            <text class="btn-label" wx:if="{{controlType === 'companion'}}">ä½å¤´</text>
          </button>
          <button class="btn-control btn-transparent"></button>
        </view>
      </view>
      
      <!-- æ·»åŠ é€Ÿåº¦æ§åˆ¶æ»‘å— -->
      <view class="speed-control">
        <text class="speed-label">ç§»åŠ¨é€Ÿåº¦ï¼š{{motorSpeed}}%</text>
        <slider bindchange="changeMotorSpeed" min="0" max="100" value="{{motorSpeed}}" 
                activeColor="#007ACC" block-size="25" show-value="{{false}}" />
        <view class="speed-indicators">
          <text>æ…¢</text>
          <text>å¿«</text>
        </view>
      </view>

      <view class="action-controls">
        <button class="btn-action" bindtap="startInteraction">å¼€å§‹äº’åŠ¨</button>
        <button class="btn-action" bindtap="pauseInteraction">æš‚åœäº’åŠ¨</button>
        <button class="btn-action btn-emergency" bindtap="emergencyStop">ç´§æ€¥åœæ­¢</button>
      </view>
    </view>

    <view class="auto-panel" wx:else>
      <view class="auto-status">
        <text class="status-label">å½“å‰çŠ¶æ€ï¼š</text>
        <text class="status-value">{{autoStatus}}</text>
      </view>
      <view class="progress-container">
        <progress percent="{{autoProgress}}" stroke-width="12" color="#007ACC" active active-mode="forwards" />
        <text class="progress-text">é™ªä¼´è¿›åº¦: {{autoProgress}}%</text>
      </view>
      <view class="auto-controls">
        <button class="btn-auto btn-start" bindtap="startAutoMode">å¼€å§‹è‡ªåŠ¨é™ªä¼´</button>
        <button class="btn-auto btn-pause" bindtap="pauseAutoMode">æš‚åœ</button>
        <button class="btn-auto btn-emergency" bindtap="emergencyStop">ç´§æ€¥åœæ­¢</button>
      </view>
    </view>
    </view>
    
    <!-- æ•°æ®å±•ç¤ºé¡µé¢å†…å®¹ -->
    <view class="tab-content" wx:if="{{currentTab === 'data'}}">
      <view class="data-header">
        <text class="title">è·Ÿè¸ªæ•°æ®</text>
        <view class="data-stats">
          <view class="stat-item">
            <text class="stat-value">{{trackingData.totalTracks}}</text>
            <text class="stat-label">æ€»è½¨è¿¹</text>
          </view>
          <view class="stat-item">
            <text class="stat-value">{{trackingData.activeTracks}}</text>
            <text class="stat-label">æ´»è·ƒ</text>
          </view>
          <view class="stat-item">
            <text class="stat-value">{{trackingData.lostTracks}}</text>
            <text class="stat-label">ä¸¢å¤±</text>
          </view>
          <!-- æ–°å¢ï¼šç³»ç»ŸçŠ¶æ€æŒ‡æ ‡ -->
          <view class="stat-item" wx:if="{{trackingData.systemInfo}}">
            <text class="stat-value">{{trackingData.systemInfo.fps || 0}}</text>
            <text class="stat-label">FPS</text>
          </view>
          <view class="stat-item" wx:if="{{trackingData.systemInfo}}">
            <text class="stat-value">{{utils.formatNumber(trackingData.systemInfo.memory_usage_mb || 0, 1)}}MB</text>
            <text class="stat-label">å†…å­˜</text>
          </view>
          <view class="stat-item" wx:if="{{trackingData.frameId}}">
            <text class="stat-value">{{trackingData.frameId}}</text>
            <text class="stat-label">å¸§å·</text>
          </view>
        </view>
      </view>
      
      <!-- å®æ—¶è·Ÿè¸ªæ•°æ®åŒºåŸŸ -->
      <view class="real-tracking-data" wx:if="{{trackingData.lastUpdateTime > 0}}">
        <view class="tracking-section-header">
          <text class="section-title">ğŸ“Š å®æ—¶è·Ÿè¸ªæ•°æ®</text>
          <text class="update-time">{{utils.formatTimeAgo(trackingData.lastUpdateTime)}}</text>
        </view>
        
        <!-- è·Ÿè¸ªçŠ¶æ€æ‘˜è¦ -->
        <view class="tracking-summary">
          <view class="summary-item">
            <text class="summary-label">è·Ÿè¸ªæ¨¡å¼</text>
            <text class="summary-value">{{trackingData.mode}}</text>
          </view>
          <view class="summary-item">
            <text class="summary-label">ç³»ç»ŸçŠ¶æ€</text>
            <text class="summary-value">{{trackingData.status}}</text>
          </view>
          <view class="summary-item">
            <text class="summary-label">æ£€æµ‹äººæ•°</text>
            <text class="summary-value">{{trackingData.totalPersons}} äºº</text>
          </view>
          <view class="summary-item">
            <text class="summary-label">æ´»è·ƒè½¨è¿¹</text>
            <text class="summary-value">{{trackingData.activeTracks}} ä¸ª</text>
          </view>
        </view>
        
        <!-- ç›®æ ‡ä¿¡æ¯ -->
        <view class="target-info" wx:if="{{trackingData.targetInfo}}">
          <text class="target-title">ğŸ¯ è·Ÿè¸ªç›®æ ‡ (ID: {{trackingData.targetInfo.id}})</text>
          <view class="target-details">
            <view class="target-item">
              <text class="target-label">è·ç¦»</text>
              <text class="target-value">{{trackingData.targetInfo.distance}}</text>
            </view>
            <view class="target-item">
              <text class="target-label">ç½®ä¿¡åº¦</text>
              <text class="target-value">{{trackingData.targetInfo.confidence}}</text>
            </view>
            <view class="target-item">
              <text class="target-label">è·Ÿè¸ªè´¨é‡</text>
              <text class="target-value">{{trackingData.targetInfo.quality}}</text>
            </view>
            <view class="target-item">
              <text class="target-label">èº«ä½“ç‰¹å¾</text>
              <text class="target-value">{{trackingData.targetInfo.bodyFeatures}} é¡¹</text>
            </view>
          </view>
          
          <!-- ç›®æ ‡é¢œè‰²ä¿¡æ¯ -->
          <view class="target-colors" wx:if="{{trackingData.targetInfo.colors}}">
            <text class="colors-title">æœè£…é¢œè‰²</text>
            <view class="color-row">
              <view class="color-item">
                <view class="color-indicator" style="background-color: {{trackingData.targetInfo.colors.upper.hex}}"></view>
                <text class="color-name">{{trackingData.targetInfo.colors.upper.name}}</text>
              </view>
              <view class="color-item">
                <view class="color-indicator" style="background-color: {{trackingData.targetInfo.colors.lower.hex}}"></view>
                <text class="color-name">{{trackingData.targetInfo.colors.lower.name}}</text>
              </view>
            </view>
          </view>
          
          <!-- ç›®æ ‡é€Ÿåº¦ä¿¡æ¯ -->
          <view class="target-velocity" wx:if="{{trackingData.targetInfo.velocity}}">
            <text class="velocity-title">è¿åŠ¨é€Ÿåº¦</text>
            <view class="velocity-info">
              <text class="velocity-item">X: {{utils.toFixed(trackingData.targetInfo.velocity.x, 2)}} px/frame</text>
              <text class="velocity-item">Y: {{utils.toFixed(trackingData.targetInfo.velocity.y, 2)}} px/frame</text>
            </view>
          </view>
        </view>
        
        <!-- æ‰€æœ‰äººå‘˜åˆ—è¡¨ -->
        <view class="persons-list" wx:if="{{trackingData.persons && trackingData.persons.length > 0}}">
          <text class="persons-title">ğŸ‘¥ æ£€æµ‹åˆ°çš„æ‰€æœ‰äººå‘˜ ({{trackingData.persons.length}})</text>
          <view class="persons-grid">
            <view class="person-card {{person.isTarget ? 'is-target' : ''}}" 
                  wx:for="{{trackingData.persons}}" 
                  wx:key="id"
                  wx:for-item="person">
              <view class="person-header">
                <text class="person-id">ID: {{person.id}}</text>
                <view class="person-target-badge" wx:if="{{person.isTarget}}">ç›®æ ‡</view>
                <text class="person-status">{{person.status}}</text>
              </view>
              <view class="person-info">
                <text class="person-distance">{{person.distance}}</text>
                <text class="person-confidence">{{person.confidence}}</text>
              </view>
              <view class="person-colors">
                <view class="color-dot" style="background-color: {{person.colors.upper.hex}}" title="{{person.colors.upper.name}}"></view>
                <view class="color-dot" style="background-color: {{person.colors.lower.hex}}" title="{{person.colors.lower.name}}"></view>
              </view>
            </view>
          </view>
        </view>
      </view>
      
      <!-- çœŸå®ç‰¹å¾æ•°æ®åŒºåŸŸ -->
      <view class="real-feature-data" wx:if="{{realFeatureData.lastUpdate > 0}}">
        <view class="feature-section-header">
          <text class="section-title">ğŸ¯ å®æ—¶ç‰¹å¾æ•°æ®</text>
          <text class="update-time">{{utils.formatTimeAgo(realFeatureData.lastUpdate)}}</text>
        </view>
        
        <!-- äººæ•°ç»Ÿè®¡ -->
        <view class="feature-item" wx:if="{{realFeatureData.personCount > 0}}">
          <view class="feature-label">
            <text class="label-icon">ğŸ‘¥</text>
            <text class="label-text">æ£€æµ‹äººæ•°</text>
          </view>
          <text class="feature-value">{{realFeatureData.personCount}} äºº</text>
        </view>
        
        <!-- æœè£…é¢œè‰² -->
        <view class="feature-colors" wx:if="{{realFeatureData.shirtColor.length > 0 || realFeatureData.pantsColor.length > 0}}">
          <text class="colors-title">æœè£…é¢œè‰²</text>
          <view class="color-info">
            <view class="color-item" wx:if="{{realFeatureData.shirtColor.length > 0}}">
              <view class="color-indicator" style="background-color: rgb({{realFeatureData.shirtColor[0]}}, {{realFeatureData.shirtColor[1]}}, {{realFeatureData.shirtColor[2]}})"></view>
              <text class="color-label">ä¸Šè¡£</text>
              <text class="color-rgb">RGB({{realFeatureData.shirtColor[0]}}, {{realFeatureData.shirtColor[1]}}, {{realFeatureData.shirtColor[2]}})</text>
            </view>
            <view class="color-item" wx:if="{{realFeatureData.pantsColor.length > 0}}">
              <view class="color-indicator" style="background-color: rgb({{realFeatureData.pantsColor[0]}}, {{realFeatureData.pantsColor[1]}}, {{realFeatureData.pantsColor[2]}})"></view>
              <text class="color-label">ä¸‹è£…</text>
              <text class="color-rgb">RGB({{realFeatureData.pantsColor[0]}}, {{realFeatureData.pantsColor[1]}}, {{realFeatureData.pantsColor[2]}})</text>
            </view>
          </view>
        </view>
        
        <!-- èº«ä½“æ¯”ä¾‹æ•°æ® -->
        <view class="feature-ratios" wx:if="{{realFeatureData.bodyRatios.length > 0}}">
          <text class="ratios-title">èº«ä½“æ¯”ä¾‹ ({{realFeatureData.bodyRatios.length}}é¡¹æ•°æ®)</text>
          <view class="ratios-grid">
            <view class="ratio-item" wx:for="{{realFeatureData.bodyRatios}}" wx:key="index" wx:if="{{index < 8}}">
              <text class="ratio-label">æ¯”ä¾‹{{index + 1}}</text>
              <text class="ratio-value">{{utils.toFixed(item, 3)}}</text>
            </view>
          </view>
          <view class="more-ratios" wx:if="{{realFeatureData.bodyRatios.length > 8}}">
            <text class="more-text">è¿˜æœ‰ {{realFeatureData.bodyRatios.length - 8}} é¡¹æ•°æ®...</text>
          </view>
        </view>
        
        <!-- ç»“æœå›¾ç‰‡ -->
        <view class="feature-image-section" wx:if="{{realFeatureData.resultImageBase64 || realFeatureData.resultImagePath}}">
          <text class="image-section-title">ğŸ“¸ ç‰¹å¾æå–ç»“æœ</text>
          
          <!-- æ˜¾ç¤ºbase64ç¼–ç çš„å›¾ç‰‡ -->
          <view class="feature-image-container" wx:if="{{realFeatureData.resultImageBase64}}">
            <image 
              class="feature-result-image" 
              src="data:image/jpeg;base64,{{realFeatureData.resultImageBase64}}" 
              mode="aspectFit"
              show-menu-by-longpress="{{true}}"
              lazy-load="{{true}}"
              bind:load="onResultImageLoad"
              bind:error="onResultImageError"
            />
            <view class="image-info">
              <text class="image-size">å¤§å°: {{realFeatureData.resultImageSize}}KB</text>
              <text class="image-hint">é•¿æŒ‰å›¾ç‰‡å¯ä¿å­˜</text>
            </view>
          </view>
          
          <!-- å¤‡ç”¨æ˜¾ç¤ºè·¯å¾„ -->
          <view class="feature-image-path" wx:else>
            <text class="path-label">ç»“æœå›¾ç‰‡è·¯å¾„:</text>
            <text class="path-value">{{realFeatureData.resultImagePath}}</text>
          </view>
        </view>
      </view>
      
      <!-- è½¨è¿¹åˆ—è¡¨ -->
      <view class="track-list" wx:if="{{trackingData.tracks.length > 0}}">
        <view class="track-item {{trackingData.targetTrackId === track.id ? 'is-target' : ''}}" 
              wx:for="{{trackingData.tracks}}" 
              wx:key="id"
              bindtap="setTargetTrack"
              data-track-id="{{item.id}}">
          
          <!-- è½¨è¿¹åŸºæœ¬ä¿¡æ¯ -->
          <view class="track-header">
            <view class="track-id">
              <text class="id-label">ID:</text>
              <text class="id-value">{{item.id}}</text>
              <view class="target-badge" wx:if="{{trackingData.targetTrackId === item.id}}">ç›®æ ‡</view>
            </view>
                         <view class="track-status" style="color: {{utils.getStatusColor(item.status)}}">
               <text class="status-dot" style="background-color: {{utils.getStatusColor(item.status)}}"></text>
               <text class="status-text">{{utils.getStatusText(item.status)}}</text>
             </view>
          </view>
          
          <!-- ç½®ä¿¡åº¦ -->
          <view class="track-confidence">
            <text class="confidence-label">ç½®ä¿¡åº¦:</text>
                         <view class="confidence-bar">
               <view class="confidence-fill" style="width: {{utils.confidencePercent(item.confidence)}}%; background-color: {{utils.getConfidenceColor(item.confidence)}}"></view>
             </view>
             <text class="confidence-value">{{utils.confidencePercent(item.confidence)}}%</text>
          </view>
          
          <!-- æœè£…é¢œè‰² -->
          <view class="track-clothing">
            <text class="clothing-label">æœè£…é¢œè‰²:</text>
            <view class="clothing-colors">
              <view class="color-item">
                <view class="color-dot" style="background-color: {{item.clothingColors.top.color}}"></view>
                <text class="color-name">ä¸Šè¡£: {{item.clothingColors.top.name}}</text>
              </view>
              <view class="color-item">
                <view class="color-dot" style="background-color: {{item.clothingColors.bottom.color}}"></view>
                <text class="color-name">ä¸‹è¡£: {{item.clothingColors.bottom.name}}</text>
              </view>
            </view>
          </view>
          
          <!-- ä½ç½®ä¿¡æ¯ -->
                     <view class="track-position">
             <text class="position-label">ä½ç½®:</text>
             <text class="position-value">X: {{utils.toFixed(item.position.x, 0)}}, Y: {{utils.toFixed(item.position.y, 0)}}</text>
             <text class="update-time">{{utils.formatTimeAgo(item.lastUpdateTime)}}</text>
           </view>
          
        </view>
      </view>
      
      <!-- è¯¦ç»†è·Ÿè¸ªæ•°æ®åŒºåŸŸ -->
      <view class="detailed-tracking-data" wx:if="{{trackingData.targetTrack || trackingData.tracks.length > 0}}">
        <view class="tracking-section-header">
          <text class="section-title">ğŸ¯ è¯¦ç»†è·Ÿè¸ªä¿¡æ¯</text>
          <text class="update-time">{{utils.formatTimeAgo(trackingData.timestamp || Date.now())}}</text>
        </view>
        
        <!-- ç›®æ ‡è½¨è¿¹è¯¦ç»†ä¿¡æ¯ -->
        <view class="target-track-detail" wx:if="{{trackingData.targetTrack}}">
          <view class="detail-card">
            <view class="card-header">
              <text class="card-title">ğŸ¯ ç›®æ ‡è½¨è¿¹ #{{trackingData.targetTrack.id}}</text>
              <view class="quality-badge {{trackingData.targetTrack.tracking_quality >= 80 ? 'high' : trackingData.targetTrack.tracking_quality >= 60 ? 'medium' : 'low'}}">
                {{utils.toFixed(trackingData.targetTrack.tracking_quality || 0, 1)}}%
              </view>
            </view>
            
            <view class="card-content">
              <view class="info-row">
                <text class="info-label">è·ç¦»:</text>
                <text class="info-value">{{utils.toFixed(trackingData.targetTrack.distance || 0, 2)}}m</text>
              </view>
              <view class="info-row">
                <text class="info-label">ç½®ä¿¡åº¦:</text>
                <text class="info-value">{{utils.toFixed(trackingData.targetTrack.confidence || 0, 2)}}</text>
              </view>
              <view class="info-row">
                <text class="info-label">ä½ç½®:</text>
                <text class="info-value">X:{{utils.toFixed(trackingData.targetTrack.position.x || 0, 0)}}, Y:{{utils.toFixed(trackingData.targetTrack.position.y || 0, 0)}}</text>
              </view>
              <view class="info-row" wx:if="{{trackingData.targetTrack.velocity}}">
                <text class="info-label">é€Ÿåº¦:</text>
                <text class="info-value">X:{{utils.toFixed(trackingData.targetTrack.velocity.x || 0, 2)}}, Y:{{utils.toFixed(trackingData.targetTrack.velocity.y || 0, 2)}}</text>
              </view>
              
              <!-- é¢œè‰²ä¿¡æ¯ -->
              <view class="color-info" wx:if="{{trackingData.targetTrack.colors}}">
                <view class="color-item">
                  <text class="color-label">ä¸Šè£…:</text>
                  <view class="color-preview" style="background-color: rgb({{trackingData.targetTrack.colors.upper.join(',')}});"></view>
                  <text class="color-rgb">{{trackingData.targetTrack.colors.upper.join(',')}}</text>
                </view>
                <view class="color-item">
                  <text class="color-label">ä¸‹è£…:</text>
                  <view class="color-preview" style="background-color: rgb({{trackingData.targetTrack.colors.lower.join(',')}});"></view>
                  <text class="color-rgb">{{trackingData.targetTrack.colors.lower.join(',')}}</text>
                </view>
              </view>
              
              <!-- èº«ä½“æ¯”ä¾‹ä¿¡æ¯ -->
              <view class="body-ratios" wx:if="{{trackingData.targetTrack.body_ratios && trackingData.targetTrack.body_ratios.length > 0}}">
                <text class="ratios-label">èº«ä½“æ¯”ä¾‹:</text>
                <view class="ratios-list">
                  <text class="ratio-item" wx:for="{{trackingData.targetTrack.body_ratios}}" wx:key="index">
                    {{utils.toFixed(item, 3)}}
                  </text>
                </view>
              </view>
            </view>
          </view>
        </view>
        
        <!-- ç³»ç»Ÿæ€§èƒ½ä¿¡æ¯ -->
        <view class="system-performance" wx:if="{{trackingData.systemInfo}}">
          <view class="detail-card">
            <view class="card-header">
              <text class="card-title">âš¡ ç³»ç»Ÿæ€§èƒ½</text>
              <view class="camera-status {{trackingData.systemInfo.camera_connected ? 'connected' : 'disconnected'}}">
                {{trackingData.systemInfo.camera_connected ? 'æ‘„åƒå¤´æ­£å¸¸' : 'æ‘„åƒå¤´æ–­å¼€'}}
              </view>
            </view>
            
            <view class="card-content">
              <view class="performance-grid">
                <view class="perf-item">
                  <text class="perf-label">å¸§ç‡</text>
                  <text class="perf-value">{{utils.toFixed(trackingData.systemInfo.fps || 0, 1)}} FPS</text>
                </view>
                <view class="perf-item">
                  <text class="perf-label">å¤„ç†æ—¶é—´</text>
                  <text class="perf-value">{{utils.toFixed(trackingData.systemInfo.processing_time_ms || 0, 1)}} ms</text>
                </view>
                <view class="perf-item">
                  <text class="perf-label">å†…å­˜ä½¿ç”¨</text>
                  <text class="perf-value">{{utils.toFixed(trackingData.systemInfo.memory_usage_mb || 0, 1)}} MB</text>
                </view>
              </view>
            </view>
          </view>
        </view>
        
        <!-- è·Ÿè¸ªç»Ÿè®¡ä¿¡æ¯ -->
        <view class="tracking-statistics" wx:if="{{trackingData.statistics}}">
          <view class="detail-card">
            <view class="card-header">
              <text class="card-title">ğŸ“Š è·Ÿè¸ªç»Ÿè®¡</text>
              <text class="mode-badge">{{trackingData.mode || 'æœªçŸ¥æ¨¡å¼'}}</text>
            </view>
            
            <view class="card-content">
              <view class="stats-grid">
                <view class="stat-cell">
                  <text class="stat-number">{{trackingData.statistics.active_tracks || 0}}</text>
                  <text class="stat-desc">æ´»è·ƒè½¨è¿¹</text>
                </view>
                <view class="stat-cell">
                  <text class="stat-number">{{trackingData.statistics.lost_tracks || 0}}</text>
                  <text class="stat-desc">ä¸¢å¤±è½¨è¿¹</text>
                </view>
                <view class="stat-cell">
                  <text class="stat-number">{{trackingData.statistics.new_tracks || 0}}</text>
                  <text class="stat-desc">æ–°è½¨è¿¹</text>
                </view>
                <view class="stat-cell">
                  <text class="stat-number">{{trackingData.targetDetected ? 'æ˜¯' : 'å¦'}}</text>
                  <text class="stat-desc">ç›®æ ‡æ£€æµ‹</text>
                </view>
              </view>
            </view>
          </view>
        </view>
      </view>
      
             <!-- æ•°æ®æ›´æ–°ä¿¡æ¯ -->
       <view class="data-footer">
         <text class="update-info">æœ€åæ›´æ–°: {{utils.formatTimeAgo(trackingData.lastUpdateTime)}}</text>
         <view class="refresh-indicator">
           <view class="pulse-dot"></view>
           <text class="refresh-text">å®æ—¶æ›´æ–°ä¸­</text>
         </view>
       </view>
    </view>
  </scroll-view>
  
  <!-- è¿æ¥æ§åˆ¶ -->
  <view class="connection-control">
    <button class="btn-refresh {{connectionChecking ? 'checking' : ''}}" bindtap="refreshConnection" disabled="{{connectionChecking}}">
      <text class="refresh-icon">âŸ³</text> {{connectionChecking ? 'æ­£åœ¨åˆ·æ–°...' : 'åˆ·æ–°è¿æ¥'}}
    </button>
  </view>
</view>