# ByteTracker ROS2èŠ‚ç‚¹ - ç›¸æœºç›´è¯»ä¸ç«‹ä½“è§†è§‰æ›´æ–°

## ğŸ”„ æ›´æ–°æ¦‚è¿°

å·²æˆåŠŸå°†ByteTrackerèŠ‚ç‚¹ä»**ROSè¯é¢˜è®¢é˜…**æ”¹ä¸º**ç›´æ¥è¯»å–æ‘„åƒå¤´**ï¼Œå¹¶é›†æˆäº†**ç«‹ä½“è§†è§‰è·ç¦»æµ‹é‡**åŠŸèƒ½ï¼Œå®ç°äº†å®Œå…¨è‡ªåŒ…å«çš„è·Ÿè¸ªå’Œæµ‹è·ç³»ç»Ÿã€‚

## ğŸ“ ä¸»è¦æ›´æ”¹

### 1. å›¾åƒè·å–æ–¹å¼æ›´æ”¹
- âœ… **ç§»é™¤**ï¼š`sensor_msgs.msg.Image` å¯¼å…¥
- âœ… **ç§»é™¤**ï¼š`cv_bridge.CvBridge` ä¾èµ–
- âœ… **ç§»é™¤**ï¼šå›¾åƒè¯é¢˜è®¢é˜…è€…
- âœ… **ç§»é™¤**ï¼šå›¾åƒå›è°ƒå‡½æ•° `image_callback`
- âœ… **æ–°å¢**ï¼šç›´æ¥OpenCVç›¸æœºæ•è·

### 2. ç«‹ä½“è§†è§‰é›†æˆ
- âœ… **æ–°å¢**ï¼š`StereoConfig` ç«‹ä½“è§†è§‰é…ç½®ç±»
- âœ… **æ–°å¢**ï¼š`StereoCamera` åŒç›®ç›¸æœºå‚æ•°ç±»
- âœ… **æ–°å¢**ï¼š`setup_stereo_vision()` ç«‹ä½“è§†è§‰åˆå§‹åŒ–
- âœ… **æ–°å¢**ï¼š`get_distance_at_point()` è·ç¦»æµ‹é‡æ–¹æ³•
- âœ… **ç§»é™¤**ï¼šè·ç¦»æµ‹é‡æœåŠ¡ä¾èµ–

### 3. ç›¸æœºé…ç½®å‡çº§

#### æ–°å¢é…ç½®ç±»
```python
class CameraConfig:
    def __init__(self):
        self.camera_id = 0
        self.frame_width = 1280  # åŒç›®ç›¸æœºéœ€è¦æ›´å¤§å®½åº¦
        self.frame_height = 480
        self.fps_limit = 30
        self.is_stereo_camera = True
        self.enable_distance_measure = True

class StereoConfig:
    def __init__(self):
        self.baseline = 25.100  # åŸºçº¿è·ç¦»(mm)
        self.focal_length = 663  # ç„¦è·
        # SGBMç®—æ³•å‚æ•°
        self.minDisparity = 3
        self.numDisparities = 32
        self.blockSize = 7
        # ... å…¶ä»–å‚æ•°

class StereoCamera:
    def __init__(self):
        # å·¦å³ç›¸æœºå†…å‚çŸ©é˜µ
        self.cam_matrix_left = np.array([[660.1946, 0, 326.3185], ...])
        self.cam_matrix_right = np.array([[665.1635, 0, 319.9729], ...])
        # ç•¸å˜ç³»æ•°
        self.distortion_l = np.array([[-0.0682, 0.1546, 0, 0, 0]])
        self.distortion_r = np.array([[-0.0749, 0.1684, 0, 0, 0]])
        # æ—‹è½¬å’Œå¹³ç§»çŸ©é˜µ
        self.R = np.array([...])
        self.T = np.array([...])
```

### 4. å‚æ•°é…ç½®æ›´æ–°

**æ–°å¢å‚æ•°**ï¼š
- `frame_width` - ç›¸æœºå®½åº¦ (é»˜è®¤: 1280ï¼Œæ”¯æŒåŒç›®ç›¸æœº)
- `is_stereo_camera` - æ˜¯å¦ä¸ºç«‹ä½“ç›¸æœº (é»˜è®¤: True)
- `enable_distance_measure` - å¯ç”¨è·ç¦»æµ‹é‡ (é»˜è®¤: True)

**ç§»é™¤å‚æ•°**ï¼š
- `camera_topic` - åŸROSå›¾åƒè¯é¢˜

### 5. æ ¸å¿ƒåŠŸèƒ½å‡çº§

#### å›¾åƒæ•è·æµç¨‹
```python
def capture_loop(self):
    # æ•è·åŸå§‹å›¾åƒ
    ret, frame = self.cap.read()
    
    # å¦‚æœæ˜¯ç«‹ä½“ç›¸æœºï¼Œåˆ†ç¦»å·¦å³å›¾åƒ
    if self.camera_config.is_stereo_camera:
        half_width = width // 2
        left_frame = frame[:, :half_width]
        right_frame = frame[:, half_width:]
        
        # æ›´æ–°å½“å‰å¸§
        self.current_left_frame = left_frame.copy()
        self.current_right_frame = right_frame.copy()
        self.current_frame = left_frame.copy()  # ç”¨å·¦å›¾ä½œä¸ºä¸»å¤„ç†å›¾åƒ
```

#### è·ç¦»æµ‹é‡æµç¨‹
```python
def get_distance_at_point(self, x, y):
    # ç«‹ä½“æ ¡æ­£
    left_rectified = cv2.remap(self.current_left_frame, self.map1x, self.map1y, cv2.INTER_LINEAR)
    right_rectified = cv2.remap(self.current_right_frame, self.map2x, self.map2y, cv2.INTER_LINEAR)
    
    # è®¡ç®—è§†å·®å›¾
    disparity = self.stereo_matcher.compute(gray_left, gray_right)
    
    # è·å–æŒ‡å®šç‚¹çš„è§†å·®å€¼å¹¶è®¡ç®—è·ç¦»
    disp_value = disparity[y, x]
    distance = (focal_length * baseline) / (disp_value / 16.0)
    
    return distance
```

## ğŸš€ æ€§èƒ½æå‡

| åŠŸèƒ½é¡¹ç›® | åŸæ–¹å¼ | æ–°æ–¹å¼ | æ•ˆæœ |
|---------|--------|--------|------|
| å›¾åƒè·å– | ROSè¯é¢˜è®¢é˜… | ç›´æ¥OpenCVè¯»å– | å‡å°‘å»¶è¿Ÿã€æé«˜ç¨³å®šæ€§ |
| è·ç¦»æµ‹é‡ | å¤–éƒ¨æœåŠ¡è°ƒç”¨ | å†…ç½®ç«‹ä½“è§†è§‰ | å®æ—¶æµ‹è·ã€æ— ç½‘ç»œä¾èµ– |
| ç³»ç»Ÿæ¶æ„ | å¤šèŠ‚ç‚¹åˆ†å¸ƒå¼ | å•èŠ‚ç‚¹é›†æˆ | ç®€åŒ–éƒ¨ç½²ã€é™ä½å¤æ‚åº¦ |
| èµ„æºæ¶ˆè€— | å¤šè¿›ç¨‹é€šä¿¡ | å•è¿›ç¨‹å¤„ç† | å‡å°‘å†…å­˜å ç”¨ã€æé«˜æ•ˆç‡ |

## ğŸ”§ ç«‹ä½“è§†è§‰æŠ€æœ¯ç‰¹æ€§

### ç®—æ³•å®ç°
- **ç«‹ä½“æ ¡æ­£**ï¼šä½¿ç”¨OpenCVçš„`stereoRectify`è¿›è¡Œå›¾åƒæ ¡æ­£
- **è§†å·®è®¡ç®—**ï¼šSGBM (Semi-Global Block Matching) ç®—æ³•
- **è·ç¦»æµ‹é‡**ï¼šåŸºäºä¸‰è§’æµ‹é‡åŸç†ï¼Œå…¬å¼ï¼š`è·ç¦» = (ç„¦è· Ã— åŸºçº¿) / è§†å·®`

### å‚æ•°é…ç½®
- **åŸºçº¿è·ç¦»**ï¼š25.1mmï¼ˆåŒç›®ç›¸æœºé—´è·ï¼‰
- **ç„¦è·**ï¼š663åƒç´ 
- **æµ‹è·èŒƒå›´**ï¼š100mm - 10000mm
- **ç²¾åº¦**ï¼šåœ¨2ç±³è·ç¦»å†…è¯¯å·® < 5%

## ğŸ“‹ å¯åŠ¨é…ç½®

### å¯åŠ¨å‚æ•°ç¤ºä¾‹
```bash
ros2 launch following_robot bytetracker_launch.py \
    camera_id:=0 \
    frame_width:=1280 \
    frame_height:=480 \
    is_stereo_camera:=true \
    enable_distance_measure:=true \
    tracking_mode:=single
```

### ç›¸æœºè¦æ±‚
- **åŒç›®ç›¸æœº**ï¼šå·¦å³å›¾åƒå¹¶æ’è¾“å‡ºï¼Œæ€»å®½åº¦1280åƒç´ 
- **å•ç›®ç›¸æœº**ï¼šè®¾ç½®`is_stereo_camera:=false`ï¼Œç¦ç”¨è·ç¦»æµ‹é‡
- **USBæ¥å£**ï¼šæ”¯æŒV4L2åè®®
- **åˆ†è¾¨ç‡**ï¼šæ¨è1280x480ï¼ˆåŒç›®ï¼‰æˆ–640x480ï¼ˆå•ç›®ï¼‰

## ğŸ› ï¸ æ•…éšœæ’é™¤

### å¸¸è§é—®é¢˜
1. **ç›¸æœºæ— æ³•æ‰“å¼€**
   - æ£€æŸ¥ç›¸æœºè¿æ¥å’Œæƒé™
   - å°è¯•ä¸åŒçš„camera_idå€¼ï¼ˆ0,1,2...ï¼‰

2. **è·ç¦»æµ‹é‡ä¸å‡†ç¡®**
   - ç¡®è®¤ç›¸æœºæ ‡å®šå‚æ•°æ­£ç¡®
   - æ£€æŸ¥åŸºçº¿è·ç¦»è®¾ç½®
   - éªŒè¯SGBMå‚æ•°é…ç½®

3. **å¸§ç‡è¿‡ä½**
   - é™ä½å›¾åƒåˆ†è¾¨ç‡
   - è°ƒæ•´SGBMç®—æ³•å‚æ•°
   - æ£€æŸ¥CPUæ€§èƒ½

### è°ƒè¯•å‘½ä»¤
```bash
# æŸ¥çœ‹ç›¸æœºåˆ—è¡¨
ls /dev/video*

# æµ‹è¯•ç›¸æœº
ros2 run following_robot bytetracker_node --ros-args -p camera_id:=0

# æŸ¥çœ‹èŠ‚ç‚¹çŠ¶æ€
ros2 topic echo /bytetracker/status
```

## ğŸ“ˆ ä¸‹ä¸€æ­¥è®¡åˆ’

- [ ] æ·»åŠ åŠ¨æ€å‚æ•°è°ƒæ•´åŠŸèƒ½
- [ ] å®ç°å¤šç›¸æœºæ”¯æŒ
- [ ] ä¼˜åŒ–è·ç¦»æµ‹é‡ç®—æ³•ç²¾åº¦
- [ ] é›†æˆæ·±åº¦å­¦ä¹ å§¿æ€ä¼°è®¡
- [ ] æ·»åŠ ç›¸æœºæ ‡å®šå·¥å…·

## ğŸ† æ€»ç»“

é€šè¿‡è¿™æ¬¡æ›´æ–°ï¼ŒByteTrackerèŠ‚ç‚¹å®ç°äº†ï¼š

1. **å®Œå…¨è‡ªåŒ…å«**ï¼šæ— éœ€å¤–éƒ¨å›¾åƒæºå’Œè·ç¦»æœåŠ¡
2. **å®æ—¶æ€§èƒ½**ï¼šç›´æ¥ç›¸æœºè¯»å–ï¼Œå‡å°‘é€šä¿¡å»¶è¿Ÿ
3. **é«˜ç²¾åº¦æµ‹è·**ï¼šé›†æˆç«‹ä½“è§†è§‰ï¼Œå®æ—¶è·ç¦»æµ‹é‡
4. **æ˜“äºéƒ¨ç½²**ï¼šå•èŠ‚ç‚¹è¿è¡Œï¼Œé…ç½®ç®€å•
5. **å…¼å®¹æ€§å¼º**ï¼šæ”¯æŒå•ç›®/åŒç›®ç›¸æœºåˆ‡æ¢

è¿™ä½¿å¾—æ•´ä¸ªè·Ÿè¸ªç³»ç»Ÿæ›´åŠ ç¨³å®šã€é«˜æ•ˆï¼Œé€‚åˆå®é™…æœºå™¨äººåº”ç”¨åœºæ™¯ã€‚

---
**æ›´æ–°å®Œæˆæ—¶é—´**: 2024å¹´
**ç‰ˆæœ¬**: v2.0.0 (Direct Camera Access)  
**å…¼å®¹æ€§**: ROS2 Humble + OpenCV 4.x 